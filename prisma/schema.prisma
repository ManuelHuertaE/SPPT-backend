datasource db {
  provider = "postgresql"
}

generator client {
  provider        = "prisma-client-js"
  engineType      = "library"
  previewFeatures = ["postgresqlExtensions"]
}

/* =======================
   ENUMS
======================= */

enum UserRole {
  SUPER_ADMIN
  OWNER
  CO_OWNER
  EMPLOYEE
}

enum PointMovementType {
  EARN
  REDEEM
  ADJUST_ADD
  ADJUST_SUB
  REFUND
}

enum RedemptionStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum TransactionStatus {
  COMPLETED
  CANCELED
  REFUNDED
}

/* =======================
   MODELS
======================= */

model Business {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  address     String?
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())

  users            User[]
  clientBusinesses ClientBusiness[]
  transactions     Transaction[]
  rewards          Reward[]
  pointRules       PointRule[]
  pointMovements   PointMovement[]
  products         Product[]
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String
  lastName  String
  password  String
  role      UserRole
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  business   Business? @relation(fields: [businessId], references: [id])
  businessId String?   @db.Uuid

  transactions  Transaction[]
  redemptions   Redemption[] @relation("AuthorizedRedemptions")
  refreshTokens RefreshToken[]
}

model Client {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  phone     String   @unique //  Teléfono único global
  email     String?  @unique //  Email único si existe
  password  String  //  Contraseña para login (opcional si solo usa QR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación muchos a muchos con Business
  clientBusinesses ClientBusiness[]
  qrTokens         QrToken[]
  refreshTokens    ClientRefreshToken[]
}

model ClientBusiness {
  id            String   @id @default(uuid()) @db.Uuid
  currentPoints Int      @default(0)
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String @db.Uuid

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String   @db.Uuid

  transactions   Transaction[]
  pointMovements PointMovement[]
  redemptions    Redemption[]

  @@unique([clientId, businessId])
  @@index([businessId, active])
  @@index([clientId, active])
}

model Product {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  sku         String?
  price       Decimal  @db.Decimal(10, 2)
  pointsValue Int?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id])
  businessId String   @db.Uuid

  transactionItems TransactionItem[]

  @@index([businessId, active])
  @@index([businessId, sku])
}

model Transaction {
  id          String            @id @default(uuid()) @db.Uuid
  totalAmount Decimal           @db.Decimal(10, 2)
  status      TransactionStatus @default(COMPLETED)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  business   Business @relation(fields: [businessId], references: [id])
  businessId String   @db.Uuid

  clientBusiness   ClientBusiness? @relation(fields: [clientBusinessId], references: [id])
  clientBusinessId String?         @db.Uuid

  user   User   @relation(fields: [userId], references: [id])
  userId String @db.Uuid

  items          TransactionItem[]
  pointMovements PointMovement[]

  @@index([businessId, createdAt])
  @@index([clientBusinessId, createdAt])
}

model TransactionItem {
  id           String  @id @default(uuid()) @db.Uuid
  quantity     Int
  unitPrice    Decimal @db.Decimal(10, 2)
  subtotal     Decimal @db.Decimal(10, 2)
  pointsEarned Int     @default(0)

  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId String      @db.Uuid

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.Uuid

  @@index([transactionId])
}

model PointMovement {
  id        String            @id @default(uuid()) @db.Uuid
  points    Int
  type      PointMovementType
  reason    String
  createdAt DateTime          @default(now())

  business   Business @relation(fields: [businessId], references: [id])
  businessId String   @db.Uuid

  clientBusiness   ClientBusiness @relation(fields: [clientBusinessId], references: [id])
  clientBusinessId String         @db.Uuid

  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  transactionId String?      @db.Uuid

  redemption   Redemption? @relation(fields: [redemptionId], references: [id])
  redemptionId String?     @db.Uuid

  @@index([businessId, clientBusinessId])
  @@index([clientBusinessId, createdAt])
}

model Reward {
  id             String   @id @default(uuid()) @db.Uuid
  name           String
  description    String?
  pointsRequired Int
  stock          Int?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())

  business   Business @relation(fields: [businessId], references: [id])
  businessId String   @db.Uuid

  redemptions Redemption[]

  @@index([businessId, active])
}

model Redemption {
  id         String           @id @default(uuid()) @db.Uuid
  pointsUsed Int
  status     RedemptionStatus @default(PENDING)
  createdAt  DateTime         @default(now())

  clientBusiness   ClientBusiness @relation(fields: [clientBusinessId], references: [id])
  clientBusinessId String         @db.Uuid

  reward   Reward @relation(fields: [rewardId], references: [id])
  rewardId String @db.Uuid

  authorizedBy   User   @relation("AuthorizedRedemptions", fields: [authorizedById], references: [id])
  authorizedById String @db.Uuid

  pointMovements PointMovement[]

  @@index([clientBusinessId, status])
  @@index([status, createdAt])
}

model PointRule {
  id                    String    @id @default(uuid()) @db.Uuid
  name                  String?
  pointsPerCurrencyUnit Float
  minAmount             Float
  validFrom             DateTime  @default(now())
  validUntil            DateTime?
  active                Boolean   @default(true)
  createdAt             DateTime  @default(now())

  business   Business @relation(fields: [businessId], references: [id])
  businessId String   @db.Uuid

  @@index([businessId, active])
}

model QrToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  client   Client @relation(fields: [clientId], references: [id])
  clientId String @db.Uuid

  @@index([clientId, used])
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid

  @@index([userId])
  @@index([token])
}

model ClientRefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String @db.Uuid

  @@index([clientId])
  @@index([token])
}