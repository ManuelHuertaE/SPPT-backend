# Backend â€“ Sistema de Puntos para Tiendas

Este proyecto es el backend de un **sistema de puntos de lealtad** para tiendas, construido con **Node.js**, **Prisma**, **PostgreSQL** y **Docker**.

El objetivo de este README es explicar **cÃ³mo levantar el proyecto**, **cÃ³mo funciona la base de datos**, y **cÃ³mo trabajar correctamente con Prisma**, evitando los errores comunes al mezclar Docker y entorno local.

---

## ğŸ§± TecnologÃ­as

* Node.js
* Prisma ORM
* PostgreSQL 17
* Docker & Docker Compose
* DBeaver (opcional, para inspecciÃ³n de la DB)

---

## ğŸ“ Estructura bÃ¡sica

```
sppt-backend/
â”œâ”€ prisma/
â”‚  â”œâ”€ schema.prisma
â”‚  â””â”€ migrations/
â”œâ”€ docker-compose.yml
â”œâ”€ .env              # entorno LOCAL (NO se sube a Git)
â”œâ”€ .env.docker       # entorno DOCKER (NO se sube a Git)
â”œâ”€ .env.example      # ejemplo para el repo
â”œâ”€ package.json
â””â”€ README.md
```

---

## ğŸ” Variables de entorno

Este proyecto usa **dos archivos de entorno distintos**, lo cual es intencional.

### `.env` â†’ entorno LOCAL

Usado por:

* Prisma CLI (`migrate`, `studio`)
* Prisma Studio
* DBeaver

```env
EXAMPLE:
DATABASE_URL="postgresql://postgres:PASS@localhost:5433/postgres"
```

ğŸ“Œ **Importante**: aquÃ­ siempre se usa `localhost`, nunca `postgres`.

---

### `.env.docker` â†’ entorno DOCKER

Usado Ãºnicamente por los contenedores.

```env
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=PASS

DATABASE_URL="postgresql://postgres:PASS@postgres:5432/postgres"
```

ğŸ“Œ Dentro de Docker, el host **sÃ­ es** `postgres`.

---

## ğŸ³ Docker

### Levantar el entorno

```bash
npm run docker:up
```

Esto:

* Levanta PostgreSQL en Docker
* Expone el puerto **5433** hacia tu mÃ¡quina

---

### Resetear la base de datos (DEV)

âš ï¸ **Esto borra todos los datos**

```bash
npm run docker:reset
```

---

## ğŸ—„ Base de datos

### Puerto

* PostgreSQL del contenedor â†’ `localhost:5433`
* PostgreSQL local (si existe) â†’ `5432`

Esto evita conflictos.

---

### ConexiÃ³n con DBeaver (opcional)

| Campo    | Valor              |
| -------- | ------------------ |
| Host     | `localhost`        |
| Port     | `5433`             |
| Database | `postgres`         |
| User     | `postgres`         |
| Password | definido en `.env` |

---

## ğŸ”„ Prisma y migraciones

### Primera migraciÃ³n

Con la base de datos corriendo:

```bash
npx prisma migrate dev --name init
```

Esto:

* Crea la carpeta `prisma/migrations`
* Genera el SQL de la migraciÃ³n
* Aplica el esquema a la base

---

### Cambios posteriores al schema

Cada vez que se modifique `schema.prisma`:

```bash
npx prisma migrate dev --name descripcion-del-cambio
```

Ejemplo:

```bash
npx prisma migrate dev --name add-user-name
```

---

### ProducciÃ³n / Docker

Dentro del contenedor se ejecuta automÃ¡ticamente:

```bash
npx prisma migrate deploy
```

---

## ğŸ§ª Prisma Studio

ğŸ“Œ **Prisma Studio se ejecuta SIEMPRE en local**, no dentro de Docker.

```bash
npx prisma studio
```

Esto abre una interfaz web para:

* Ver tablas
* Crear / editar registros
* Ver relaciones

ğŸ‘‰ Prisma Studio usa el archivo `.env` local.

## ğŸ§  Flujo recomendado de trabajo

1. Levantar Docker
2. Crear / modificar modelos Prisma
3. Ejecutar migraciones en local
4. Verificar con Prisma Studio
5. Inspeccionar con DBeaver si es necesario


## âœï¸ Notas finales

Este setup estÃ¡ diseÃ±ado para:

* Evitar conflictos de puertos
* Separar responsabilidades (Docker vs local)
* Facilitar el desarrollo y escalado futuro

